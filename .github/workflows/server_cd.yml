name: Deploy to DO

on:
    push:
        branches:
            - master
        paths:
            - "server/**"
            - "engine/**"
            - ".github/workflows/server_cd.yml"

env:
    IMAGE_NAME: server
    REGISTRY: registry.digitalocean.com/zaiamlata-container

jobs:
    deploy:
        runs-on: ubuntu-latest

        steps:
          - name: Checkout repo
            uses: actions/checkout@v3

          - name: Install doctl 
            uses: digitalocean/action-doctl@v2
            with:
              token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

          - name: Log in to DO Container Registry 
            run: doctl registry login --expiry-seconds 600

          - name: Set up Docker Buildx
            uses: docker/setup-buildx-action@v1
            id: buildx
            with:
              install: true

          - name: Build image
            run: |
              docker build build --platform linux/amd64 -t $(echo $IMAGE_NAME) -f ./server/Dockerfile --cache-to type=gha --cache-from type=gha --load
            
          - name: Push image
            run: |
              docker tag $(echo $IMAGE_NAME):latest $(echo $REGISTRY)/$(echo $IMAGE_NAME):latest
              docker push $(echo $REGISTRY)/$(echo $IMAGE_NAME):latest
            